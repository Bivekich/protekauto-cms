#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–∞
set -e

echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "package.json" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª stack.env
if [ ! -f "stack.env" ]; then
    echo "‚ùå –§–∞–π–ª stack.env –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
echo "üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ stack.env..."
source stack.env
export $(cut -d= -f1 stack.env | grep -v '^#')

# –ü—Ä–æ–≤–µ—Ä—è–µ–º SMS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üì± –ü—Ä–æ–≤–µ—Ä–∫–∞ SMS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
if [ -z "$BEELINE_SMS_USER" ] || [ -z "$BEELINE_SMS_PASS" ]; then
    echo "‚ö†Ô∏è  SMS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
else
    echo "‚úÖ SMS API –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $BEELINE_SMS_USER)"
    echo "   –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: ${BEELINE_SMS_SENDER:-Protekauto}"
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –Ω–æ–≤—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π..."
docker-compose down
docker-compose up -d

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞..."
sleep 15

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
if docker-compose ps | grep -q "Up"; then
    echo "‚úÖ –°–µ—Ä–≤–∏—Å —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º SMS API –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
    if [ ! -z "$BEELINE_SMS_USER" ] && [ ! -z "$BEELINE_SMS_PASS" ]; then
        echo "üì± –ü—Ä–æ–≤–µ—Ä–∫–∞ SMS API..."
        sleep 5
        if curl -s -f "http://localhost:3000/api/sms/status" > /dev/null; then
            echo "‚úÖ SMS API —Ä–∞–±–æ—Ç–∞–µ—Ç"
        else
            echo "‚ö†Ô∏è  SMS API –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        fi
    fi
    
    echo ""
    echo "üéâ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
    echo "üåê CMS: http://localhost:3000"
    echo "üìä SMS —Å—Ç–∞—Ç—É—Å: http://localhost:3000/api/sms/status"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ"
    docker-compose logs --tail=50
    exit 1
fi

echo "üîß –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è PartsAPI..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ PartsAPI
if docker exec protekauto-cms-protekauto-cms-1 printenv | grep -q "PARTSAPI_"; then
    echo "‚ö†Ô∏è  –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ PartsAPI —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ"
    docker exec protekauto-cms-protekauto-cms-1 printenv | grep "PARTSAPI_"
else
    echo "‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ PartsAPI –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ!"
    echo ""
    echo "üîë –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:"
    echo ""
    echo "PARTSAPI_CATEGORIES_KEY=8260834d954cf000b9d61cc31ff0655d"
    echo "PARTSAPI_ARTICLES_KEY=a516f2b87c4f98c078f5e758d6d44a91"
    echo "PARTSAPI_MEDIA_KEY=230d8c7118a36cc6d36d72681b76982b"
    echo ""
    echo "üìù –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:"
    echo "docker-compose down && docker-compose up -d"
fi

echo ""
echo "üîç –¢–µ–∫—É—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:"
docker exec protekauto-cms-protekauto-cms-1 printenv | grep -E "(PARTSAPI_|LAXIMO_|AUTOEURO_)" || echo "–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ API –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" 