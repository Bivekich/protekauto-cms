#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è ProtekAuto CMS —Å SMS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π
set -e

echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è ProtekAuto CMS..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "package.json" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose down --remove-orphans

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
if [ ! -f "stack.env" ]; then
    echo "‚ùå –§–∞–π–ª stack.env –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º SMS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üì± –ü—Ä–æ–≤–µ—Ä–∫–∞ SMS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
source stack.env
export $(cut -d= -f1 stack.env | grep -v '^#')

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è SMS
if [ -z "$BEELINE_SMS_USER" ] || [ -z "$BEELINE_SMS_PASS" ]; then
    echo "‚ö†Ô∏è  SMS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã. SMS —Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã."
    echo "   –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SMS –¥–æ–±–∞–≤—å—Ç–µ –≤ stack.env:"
    echo "   BEELINE_SMS_USER=–≤–∞—à_–ª–æ–≥–∏–Ω"
    echo "   BEELINE_SMS_PASS=–≤–∞—à_–ø–∞—Ä–æ–ª—å"
    echo "   BEELINE_SMS_SENDER=Protekauto"
    echo ""
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–µ–ø–ª–æ–π –±–µ–∑ SMS? (y/n): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
else
    echo "‚úÖ SMS API –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $BEELINE_SMS_USER)"
fi

# –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
echo "üî® –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
docker-compose build --no-cache

# –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üöÄ –ó–∞–ø—É—Å–∫ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose up -d

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞..."
sleep 30

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞..."
if docker-compose ps | grep -q "Up"; then
    echo "‚úÖ –°–µ—Ä–≤–∏—Å —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º SMS API –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
    if [ ! -z "$BEELINE_SMS_USER" ] && [ ! -z "$BEELINE_SMS_PASS" ]; then
        echo "üì± –ü—Ä–æ–≤–µ—Ä–∫–∞ SMS API..."
        sleep 5
        if curl -s -f "http://localhost:3000/api/sms/status" > /dev/null; then
            echo "‚úÖ SMS API —Ä–∞–±–æ—Ç–∞–µ—Ç"
        else
            echo "‚ö†Ô∏è  SMS API –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        fi
    fi
    
    echo ""
    echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    echo "üåê CMS –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:3000"
    echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ SMS: http://localhost:3000/api/sms/status"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–∏—Å–∞"
    echo "–õ–æ–≥–∏:"
    docker-compose logs
    exit 1
fi 